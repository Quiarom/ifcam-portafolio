---
import '../styles/components/contact-form.css';
---

<div class="contact-form-container" id="contact">
  <h2 id="contactFormTitle" class="text-4xl font-bold tracking-wide text-white mb-4 py-5">Contact</h2>
  
  <form id="contactForm" class="contact-form" novalidate aria-labelledby="contactFormTitle" autocomplete="on">
    <div class="form-row">
      <div class="form-group">
        <label for="name" class="form-label">
          Nombre *
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          class="form-input"
          placeholder="Tu nombre completo"
          aria-required="true"
          aria-label="Nombre"
          autocomplete="name"
          minlength="2"
          maxlength="60"
        />
      </div>
      
      <div class="form-group">
        
        <label for="email" class="form-label">
          Email *
                  <span id="emailError" class="input-error-message" style="display:none;color:#e53e3e;font-size:0.95em;margin-top:2px;">Por favor ingresa un correo válido.</span>
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          class="form-input"
          placeholder="tu@email.com"
          aria-required="true"
          aria-label="Email"
          autocomplete="email"
          inputmode="email"
          maxlength="100"
        />
      </div>
    </div>
    
    <div class="form-group">
      <label for="subject" class="form-label">
        Asunto *
      </label>
      <input
        type="text"
        id="subject"
        name="subject"
        required
        class="form-input"
        placeholder="¿En qué puedo ayudarte?"
        aria-required="true"
        aria-label="Asunto"
        autocomplete="off"
        minlength="3"
        maxlength="100"
      />
    </div>
    
    <div class="form-group">
      <label for="message" class="form-label">
        Mensaje *
      </label>
          <span id="subjectError" class="input-error-message" style="display:none;color:#e53e3e;font-size:0.95em;margin-top:2px;">Por favor ingresa un asunto.</span>
      <textarea
        id="message"
        name="message"
        rows="6"
        required
        class="form-textarea"
        placeholder="Cuéntame sobre tu proyecto o consulta..."
        aria-required="true"
        aria-label="Mensaje"
        minlength="10"
        maxlength="1000"
        autocomplete="off"
      ></textarea>
    </div>
    
    <div class="form-group">
      <button
        type="submit"
        id="submitBtn"
        class="form-submit"
        aria-busy="false"
        aria-live="polite"
      >
        <span id="messageError" class="input-error-message" style="display:none;color:#e53e3e;font-size:0.95em;margin-top:2px;">Por favor ingresa un mensaje (mínimo 10 caracteres).</span>
        <span id="submitText" class="submit-text">Enviar Mensaje</span>
        <span id="loadingText" class="loading-text hidden" aria-hidden="true">Enviando...</span>
      </button>
    </div>
  </form>
  
  <div id="successMessage" class="form-message success hidden">
    <div class="form-message-content">
      <svg class="form-message-icon" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
      </svg>
      <p class="form-message-text">
        ¡Mensaje enviado correctamente! Te responderé pronto.
      </p>
    </div>
  </div>
  
  <!-- Error Message -->
  <div id="errorMessage" class="form-message error hidden">
    <div class="form-message-content">
      <svg class="form-message-icon" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
      </svg>
      <p id="errorText" class="form-message-text">
        Error al enviar el mensaje. Por favor intenta de nuevo.
      </p>
    </div>
  </div>
</div>

<script>
  (() => {
    const form = document.getElementById('contactForm') as HTMLFormElement | null;
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null;
    const submitText = document.getElementById('submitText');
    const loadingText = document.getElementById('loadingText');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');

    if (!form) return;

    function validateFields() {
      if (!form) return false;
      let valid = true;
      for (const el of Array.from(form.elements)) {
        if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) {
          if (!el.checkValidity()) {
            el.classList.add('input-error');
            valid = false;
          } else {
            el.classList.remove('input-error');
          }
        }
      }
      return valid;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      successMessage?.classList.add('hidden');
      errorMessage?.classList.add('hidden');

      if (!validateFields()) {
        if (errorText) errorText.textContent = 'Por favor, completa todos los campos correctamente.';
        errorMessage?.classList.remove('hidden');
        errorMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      if (submitBtn) {
        submitBtn.setAttribute('aria-busy', 'true');
        submitBtn.disabled = true;
      }
      submitText?.classList.add('hidden');
      loadingText?.classList.remove('hidden');
      loadingText?.setAttribute('aria-hidden', 'false');

      try {
        const formData = new FormData(form);
        const response = await fetch('/api/contact', {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();
        if (result.success) {
          successMessage?.classList.remove('hidden');
          form.reset();
          successMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          if (errorText) errorText.textContent = result.error || 'Error al enviar el mensaje';
          errorMessage?.classList.remove('hidden');
          errorMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (error) {
        if (errorText) errorText.textContent = 'Error de conexión. Por favor intenta de nuevo.';
        errorMessage?.classList.remove('hidden');
        errorMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } finally {
        if (submitBtn) {
          submitBtn.setAttribute('aria-busy', 'false');
          submitBtn.disabled = false;
        }
        submitText?.classList.remove('hidden');
        loadingText?.classList.add('hidden');
        loadingText?.setAttribute('aria-hidden', 'true');
      }
    });

    if (form) {
      const emailInput = form.querySelector('#email');
      const emailError = document.getElementById('emailError');
      for (const el of Array.from(form.elements)) {
        if (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement) {
          el.addEventListener('input', () => {
            if (el.checkValidity()) {
              el.classList.remove('input-error');
              if (el === emailInput && emailError) {
                emailError.style.display = 'none';
              }
            } else {
              if (el === emailInput && emailError) {
                emailError.style.display = 'block';
              }
            }
          });
        }
      }
    }
  })();
</script>